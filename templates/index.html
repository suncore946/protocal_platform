<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <i class="fa-solid fa-gamepad"></i>
      <span>{{ title }}</span>
    </div>
    <nav class="nav-menu">
      <div class="nav-item active" data-tab="protocol">
        <i class="fa-solid fa-flask"></i> 协议测试
      </div>
      <div class="nav-item" data-tab="doc">
        <i class="fa-solid fa-book"></i> 协议清单
      </div>
      <div class="nav-item" data-tab="gacha">
        <i class="fa-solid fa-wand-magic-sparkles"></i> 抽卡模拟
      </div>
       <div class="nav-item" data-tab="battle">
        <i class="fa-solid fa-shield-halved"></i> 数值比拼
      </div>
    </nav>
    <div class="sidebar-footer">
      Powered by SunCore.Y
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    
    <!-- Protocol Test View -->
    <section class="view-section active" id="view-protocol">
      <div class="page-header">
        <h1 class="page-title">协议测试</h1>
        <p class="page-desc">选择协议并配置参数进行接口调试。</p>
      </div>

      <div class="card">
        <div class="grid-cols-2" style="align-items: end;">
           <div class="form-group">
            <label class="label">选择协议</label>
            <select id="protocolSelect" class="select">
              <option value="" disabled selected>加载中...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="label">全局服务器地址</label>
             <div style="display: flex; gap: 10px;">
                <input type="text" id="globalUrl" class="input" placeholder="{{ game_server }}" />
                <button id="saveGlobalUrl" class="btn btn-secondary">更新</button>
             </div>
          </div>
        </div>
      </div>

      <div class="grid-cols-2">
        <!-- Left: Input & Config -->
        <div>
          <div class="card">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
                <h3 style="margin:0; font-size:16px;">请求参数</h3>
                <span id="callTypeBadge" class="status-badge" style="background:#e5e7eb; color:#6b7280;">HTTP</span>
             </div>
             
             <!-- Sub-case Selection -->
             <div id="subCaseArea" style="display:none; margin-bottom: 20px;">
                <label class="label">预设用例</label>
                <div id="casePills" class="case-pills"></div>
             </div>

             <!-- Dynamic Form -->
             <form id="paramForm"></form>
          </div>

          <div class="card">
            <h3 style="margin:0 0 16px 0; font-size:16px;">高级选项</h3>
            <div class="form-group">
               <label class="label">调用并发数</label>
               <input type="number" id="concurrency" class="input" value="1" min="1" max="50" />
            </div>
            <div class="form-group">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="checkbox" id="withRandom" /> 
                <span>启用随机参数 (Random Seed)</span>
              </label>
            </div>
            <button id="callBtn" class="btn" style="width:100%;">
              <i class="fa-solid fa-play" style="margin-right:8px;"></i> 发起调用
            </button>
          </div>
        </div>

        <!-- Right: Response -->
        <div>
          <div class="card">
            <h3 style="margin:0 0 16px 0; font-size:16px;">响应结果</h3>
            <div class="response-container">
               <pre id="responseBox" class="response-box">等待调用...</pre>
            </div>
          </div>
          
          <div class="card">
             <h3 style="margin:0 0 16px 0; font-size:16px;">协议说明</h3>
             <div id="protocolDesc" style="font-size:14px; color:#4b5563; line-height:1.5;">
               暂无说明
             </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Protocol Doc View -->
    <section class="view-section" id="view-doc">
      <div class="page-header">
        <h1 class="page-title">协议清单</h1>
        <p class="page-desc">查看系统中定义的所有协议详情及其说明。</p>
      </div>

      <div class="card">
        <table class="proto-table">
          <thead>
             <tr>
               <th>ID</th>
               <th>协议名称</th>
               <th>类型</th>
               <th>说明</th>
               <th>服务器信息</th>
             </tr>
          </thead>
          <tbody id="docTableBody">
             <tr><td colspan="5">加载中...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Placeholders -->
    <section class="view-section" id="view-gacha">
       <div class="page-header"><h1 class="page-title">抽卡模拟</h1></div>
       <div class="card">功能开发中...</div>
    </section>
     <section class="view-section" id="view-battle">
       <div class="page-header"><h1 class="page-title">数值比拼</h1></div>
       <div class="card">功能开发中...</div>
    </section>

  </main>

  <script>
    // --- State & Refs ---
    const els = {
      navItems: document.querySelectorAll('.nav-item'),
      views: document.querySelectorAll('.view-section'),
      protocolSelect: document.getElementById('protocolSelect'),
      paramForm: document.getElementById('paramForm'),
      responseBox: document.getElementById('responseBox'),
      callBtn: document.getElementById('callBtn'),
      protocolDesc: document.getElementById('protocolDesc'),
      subCaseArea: document.getElementById('subCaseArea'),
      casePills: document.getElementById('casePills'),
      callTypeBadge: document.getElementById('callTypeBadge'),
      docTableBody: document.getElementById('docTableBody'),
      globalUrl: document.getElementById('globalUrl'),
      saveGlobalUrl: document.getElementById('saveGlobalUrl')
    };

    let currentProtocolData = null;

    // --- Navigation ---
    els.navItems.forEach(item => {
      item.addEventListener('click', () => {
        const tabName = item.dataset.tab;
        
        // Update Nav UI
        els.navItems.forEach(n => n.classList.remove('active'));
        item.classList.add('active');

        // Update View
        els.views.forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + tabName).classList.add('active');

        // Special actions
        if (tabName === 'doc') loadDocTable();
      });
    });

    // --- Core Logic ---
    
    // 1. Initial Load
    fetch('/api/protocols')
      .then(res => res.json())
      .then(data => {
        els.protocolSelect.innerHTML = '<option value="" disabled selected>请选择协议</option>';
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = '[' + p.id + '] ' + p.name;
          els.protocolSelect.appendChild(opt);
        });
      });

    // 2. Load Protocol Details
    els.protocolSelect.addEventListener('change', (e) => {
      const id = e.target.value;
      if(!id) return;

      fetch('/api/protocol/' + id)
        .then(res => res.json())
        .then(data => {
          currentProtocolData = data;
          renderProtocolUI(data);
        });
    });

    function renderProtocolUI(data) {
      // Basic Info
      els.protocolDesc.textContent = data.description || '暂无说明';
      els.callTypeBadge.textContent = (data.call_type || 'HTTP').toUpperCase();
      
      // Render Sub-cases (Pills)
      els.casePills.innerHTML = '';
      if (data.test_cases && data.test_cases.length > 0) {
        els.subCaseArea.style.display = 'block';
        
        // Add "Default" pill
        const defaultPill = createPill('默认', data.params, true);
        els.casePills.appendChild(defaultPill);

        data.test_cases.forEach(c => {
           // Merge: case params override default params
           const mergedParams = { ...data.params, ...c.params };
           const pill = createPill(c.name || 'Case', mergedParams, false);
           els.casePills.appendChild(pill);
        });

      } else {
        els.subCaseArea.style.display = 'none';
        // Just render default form
        renderForm(data.params);
      }
    }

    function createPill(label, params, isActive) {
      const btn = document.createElement('div');
      btn.className = 'pill' + (isActive ? ' active' : '');
      btn.textContent = label;
      btn.onclick = () => {
         // UI toggle
         document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
         btn.classList.add('active');
         // Render Form
         renderForm(params);
      };
      
      // If it's the default one being created first, render it immediately
      if (isActive) renderForm(params);
      
      return btn;
    }

    function renderForm(params) {
      els.paramForm.innerHTML = '';
      if (!params || Object.keys(params).length === 0) {
        els.paramForm.innerHTML = '<div style="color:#9ca3af; font-size:14px;">无需参数</div>';
        return;
      }

      for (const [key, conf] of Object.entries(params)) {
        const group = document.createElement('div');
        group.className = 'form-group';
        
        const label = document.createElement('label');
        label.className = 'label';
        label.textContent = key;
        
        let input;
        
        // Determine if this is a schema object or a direct value
        // Schema usually has 'type' or 'default'
        const isSchema = (typeof conf === 'object' && conf !== null && (conf.type || conf.default !== undefined));
        
        let val = '';
        let type = 'string';

        if (isSchema) {
            val = (conf.default !== undefined) ? conf.default : '';
            type = conf.type || 'string';
        } else {
            val = conf;
            if (typeof conf === 'number') type = 'integer';
            else if (typeof conf === 'boolean') type = 'boolean';
        }

        if (type === 'boolean') {
           input = document.createElement('select');
           input.className = 'select';
           input.innerHTML = '<option value="true">True</option><option value="false">False</option>';
           input.value = String(val);
        } else {
           input = document.createElement('input');
           input.className = 'input';
           input.value = (val !== undefined && val !== null) ? val : '';
           
           if (type === 'integer') {
             input.type = 'number';
           } else {
             input.type = 'text';
           }
        }
        
        input.name = key;
        group.appendChild(label);
        group.appendChild(input);
        els.paramForm.appendChild(group);
      }
    }

    // 3. Document List
    let docLoaded = false;
    function loadDocTable() {
      if(docLoaded) return;
      
      fetch('/api/doc')
        .then(res => res.json())
        .then(list => {
           els.docTableBody.innerHTML = '';
           list.forEach(item => {
             const tr = document.createElement('tr');
             
             // Target Info
             let target = '-';
             if (item.target_config) {
                if (item.target_config.url) target = item.target_config.url;
                else if (item.target_config.host) target = item.target_config.host + ':' + (item.target_config.port || '');
             }

             tr.innerHTML = 
               '<td>' + item.id + '</td>' +
               '<td><span style="font-weight:600;">' + (item.name || '') + '</span></td>' +
               '<td><span class="code-snippet">' + (item.call_type || 'HTTP') + '</span></td>' +
               '<td style="color:#6b7280; font-size:13px;">' + (item.description || '-') + '</td>' +
               '<td style="font-size:13px;">' + target + '</td>';
             
             els.docTableBody.appendChild(tr);
           });
           docLoaded = true;
        });
    }

    // 4. Call API
    els.callBtn.addEventListener('click', () => {
       if (!currentProtocolData) return alert('请先选择协议');
       
       els.callBtn.disabled = true;
       els.callBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 请求中...';
       els.responseBox.textContent = '请求中...';
       
       // Gather params
       const payload = { params: {} };
       const formData = new FormData(els.paramForm);
       
       // Need to parse types based on currentProtocolData definition?
       // For simplicity, we trust the backend or basic JS parsing
       // But ideally, we should map back to defined types.
       
       // Simple mapping:
       for (const [key, value] of formData.entries()) {
           // Basic Number inference
           if (!isNaN(value) && value.trim() !== '') {
              payload.params[key] = Number(value);
           } else if (value === 'true') {
              payload.params[key] = true;
           } else if (value === 'false') {
              payload.params[key] = false;
           } else {
              payload.params[key] = value;
           }
       }
       
       const concurrency = document.getElementById('concurrency').value;
       const withRandom = document.getElementById('withRandom').checked;
       
       payload.concurrency = concurrency;
       payload.with_random = withRandom;

       fetch('/api/protocol/' + currentProtocolData.id + '/call', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
       })
       .then(res => res.json())
       .then(data => {
          els.responseBox.textContent = JSON.stringify(data, null, 2);
       })
       .catch(err => {
          els.responseBox.textContent = 'Error: ' + err;
       })
       .finally(() => {
          els.callBtn.disabled = false;
          els.callBtn.innerHTML = '<i class="fa-solid fa-play" style="margin-right:8px;"></i> 发起调用';
       });
    });

  </script>
</body>
</html>
